require('should');
var fs = require('fs')
  , async = require('async')
  , rimraf = require('rimraf')
  , createModule = require(__dirname + '/../commands/create-module')
  , projectdir = __dirname + '/workspace/dummy-project';


describe('Create Module', function(){
  before(function(done){
    rimraf(projectdir, function(err, res){
      async.forEachSeries([projectdir, projectdir+'/module', projectdir+'/config'], fs.mkdir, function(){
        fs.writeFile(projectdir+'/config/application.config.php', config, done);
      });
    });
  });

  it('should create expected directory structure', function(done){
    createModule(['Album'], projectdir, function(err){
      // verify dir structure
      async.every([
        projectdir+'/module/Album/config', 
        projectdir+'/module/Album/src/Album/Controller',
        projectdir+'/module/Album/src/Album/Form',
        projectdir+'/module/Album/src/Album/Model',
        projectdir+'/module/Album/view/album/album',
        projectdir+'/module/Album/config/Module.php',
        projectdir+'/module/Album/config/module.config.php'
      ], fs.exists, function(result){
        result.should.eql(true);
        done();
      });
    });
  });
 
  it('should be able to add module name to application.config.php', function(){
    var result = createModule.addToApplication('Warble', config).split('\n');

    result[3].should.eql("        'Application',");
    result[4].should.eql("        'Warble',");
    result[5].should.eql("    ),");
  });
});

var config = [
"// conﬁg/application.conﬁg.php:",
"return array(",
"    'modules' => array(",
"        'Application',",
"    ),",
"",
"  'module_listener_options' => array(",
"        'config_glob_paths'    => array(",
"            'config/autoload/{,*.}{global,local}.php',",
"        ),",
"        'module_paths' => array(",
"            './module',",
"            './vendor',",
"        ),",
"    ),",
");"
].join('\n');
